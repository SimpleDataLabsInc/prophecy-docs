"use strict";(self.webpackChunkdocs_4=self.webpackChunkdocs_4||[]).push([[23852],{15680:(e,t,a)=>{a.d(t,{xA:()=>c,yg:()=>g});var r=a(96540);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},l=Object.keys(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var i=r.createContext({}),p=function(e){var t=r.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(a),f=n,g=u["".concat(i,".").concat(f)]||u[f]||m[f]||l;return a?r.createElement(g,o(o({ref:t},c),{},{components:a})):r.createElement(g,o({ref:t},c))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,o=new Array(l);o[0]=f;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[u]="string"==typeof e?e:n,o[1]=s;for(var p=2;p<l;p++)o[p]=a[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}f.displayName="MDXCreateElement"},19365:(e,t,a)=>{a.d(t,{A:()=>o});var r=a(96540),n=a(20053);const l={tabItem:"tabItem_Ymn6"};function o(e){let{children:t,hidden:a,className:o}=e;return r.createElement("div",{role:"tabpanel",className:(0,n.A)(l.tabItem,o),hidden:a},t)}},11470:(e,t,a)=>{a.d(t,{A:()=>v});var r=a(58168),n=a(96540),l=a(20053),o=a(23104),s=a(56347),i=a(57485),p=a(31682),c=a(89466);function u(e){return function(e){return n.Children.map(e,(e=>{if(!e||(0,n.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:a,attributes:r,default:n}}=e;return{value:t,label:a,attributes:r,default:n}}))}function m(e){const{values:t,children:a}=e;return(0,n.useMemo)((()=>{const e=t??u(a);return function(e){const t=(0,p.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function f(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:a}=e;const r=(0,s.W6)(),l=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,i.aZ)(l),(0,n.useCallback)((e=>{if(!l)return;const t=new URLSearchParams(r.location.search);t.set(l,e),r.replace({...r.location,search:t.toString()})}),[l,r])]}function d(e){const{defaultValue:t,queryString:a=!1,groupId:r}=e,l=m(e),[o,s]=(0,n.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!f({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=a.find((e=>e.default))??a[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:l}))),[i,p]=g({queryString:a,groupId:r}),[u,d]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,l]=(0,c.Dv)(a);return[r,(0,n.useCallback)((e=>{a&&l.set(e)}),[a,l])]}({groupId:r}),y=(()=>{const e=i??u;return f({value:e,tabValues:l})?e:null})();(0,n.useLayoutEffect)((()=>{y&&s(y)}),[y]);return{selectedValue:o,selectValue:(0,n.useCallback)((e=>{if(!f({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);s(e),p(e),d(e)}),[p,d,l]),tabValues:l}}var y=a(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function k(e){let{className:t,block:a,selectedValue:s,selectValue:i,tabValues:p}=e;const c=[],{blockElementScrollPositionUntilNextRender:u}=(0,o.a_)(),m=e=>{const t=e.currentTarget,a=c.indexOf(t),r=p[a].value;r!==s&&(u(t),i(r))},f=e=>{let t=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const a=c.indexOf(e.currentTarget)+1;t=c[a]??c[0];break}case"ArrowLeft":{const a=c.indexOf(e.currentTarget)-1;t=c[a]??c[c.length-1];break}}t?.focus()};return n.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.A)("tabs",{"tabs--block":a},t)},p.map((e=>{let{value:t,label:a,attributes:o}=e;return n.createElement("li",(0,r.A)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>c.push(e),onKeyDown:f,onClick:m},o,{className:(0,l.A)("tabs__item",b.tabItem,o?.className,{"tabs__item--active":s===t})}),a??t)})))}function h(e){let{lazy:t,children:a,selectedValue:r}=e;const l=(Array.isArray(a)?a:[a]).filter(Boolean);if(t){const e=l.find((e=>e.props.value===r));return e?(0,n.cloneElement)(e,{className:"margin-top--md"}):null}return n.createElement("div",{className:"margin-top--md"},l.map(((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function N(e){const t=d(e);return n.createElement("div",{className:(0,l.A)("tabs-container",b.tabList)},n.createElement(k,(0,r.A)({},e,t)),n.createElement(h,(0,r.A)({},e,t)))}function v(e){const t=(0,y.A)();return n.createElement(N,(0,r.A)({key:String(t)},e))}},69857:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>g,frontMatter:()=>s,metadata:()=>p,toc:()=>u});var r=a(58168),n=(a(96540),a(15680)),l=a(11470),o=a(19365);const s={title:"Kafka",id:"kafka",description:"Reading and writing data from Apache Kafka in batch mode",tags:["gems","file","kafka"]},i=void 0,p={unversionedId:"Spark/gems/source-target/file/kafka",id:"Spark/gems/source-target/file/kafka",title:"Kafka",description:"Reading and writing data from Apache Kafka in batch mode",source:"@site/docs/Spark/gems/source-target/file/kafka-stream.md",sourceDirName:"Spark/gems/source-target/file",slug:"/Spark/gems/source-target/file/kafka",permalink:"/Spark/gems/source-target/file/kafka",draft:!1,tags:[{label:"gems",permalink:"/tags/gems"},{label:"file",permalink:"/tags/file"},{label:"kafka",permalink:"/tags/kafka"}],version:"current",frontMatter:{title:"Kafka",id:"kafka",description:"Reading and writing data from Apache Kafka in batch mode",tags:["gems","file","kafka"]},sidebar:"mySidebar",previous:{title:"JSON",permalink:"/Spark/gems/source-target/file/json"},next:{title:"ORC",permalink:"/Spark/gems/source-target/file/orc"}},c={},u=[{value:"Source",id:"source",level:2},{value:"Source Parameters",id:"source-parameters",level:3},{value:"Example",id:"source-example",level:3},{value:"Generated Code",id:"source-code",level:3},{value:"Target",id:"target",level:2},{value:"Target Parameters",id:"target-parameters",level:3},{value:"Example",id:"target-example",level:3},{value:"Generated Code",id:"target-code",level:3},{value:"Example pipelines",id:"example-pipelines",level:2},{value:"Source pipeline example",id:"source-pipeline-example",level:3},{value:"Metadata Table",id:"metadata-table",level:4},{value:"Spark Code used for script component",id:"spark-code-used-for-script-component",level:4}],m={toc:u},f="wrapper";function g(e){let{components:t,...s}=e;return(0,n.yg)(f,(0,r.A)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("p",null,(0,n.yg)("a",{parentName:"p",href:"https://kafka.apache.org/"},"Apache Kafka")," is an open-source distributed event streaming platform. Supporting a number of streaming paradigms it's used by thousands of companies and organizations in scenarios including Data Ingestion, Analytics and more."),(0,n.yg)("p",null,"This source currently connects with Kafka Brokers in ",(0,n.yg)("strong",{parentName:"p"},"Batch")," mode."),(0,n.yg)("h2",{id:"source"},"Source"),(0,n.yg)("p",null,"Reads data from Kafka stream in batch mode. Data is read only incrementally from the last offset stored in the specified Metadata table. If the Metadata table is not present, then data will be read from the ",(0,n.yg)("inlineCode",{parentName:"p"},"earliest")," offset."),(0,n.yg)("h3",{id:"source-parameters"},"Source Parameters"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"left"},"Parameter"),(0,n.yg)("th",{parentName:"tr",align:"left"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"left"},"Required"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Broker List"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Comma separated list of Kafka brokers"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Group Id"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Kafka consumer group ID"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Session Timeout"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Session timeout for Kafka. (Default value set to 6000s)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"False")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Security Protocol"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Security protocol for Kafka (Default value set to SASL_SSL)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"SASL Mechanism"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Default SASL Mechanism for SASL_SSL (Default value set to SCRAM-SHA-256)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Type"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Type provider (Databricks Secrets or Username/Password)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Scope"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Scope to use for Databricks secrets"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Kafka Topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Comma separated list of Kafka topics"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Metadata Table"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Table name which would be used to store offsets for each topic, partition"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")))),(0,n.yg)("h3",{id:"source-example"},"Example"),(0,n.yg)("p",null,(0,n.yg)("img",{alt:"Example usage of Filter",src:a(38999).A,width:"3024",height:"1590"})),(0,n.yg)("h3",{id:"source-code"},"Generated Code"),(0,n.yg)(l.A,{mdxType:"Tabs"},(0,n.yg)(o.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-py"},'def KafkaSource(spark: SparkSession) -> DataFrame:\n    from delta.tables import DeltaTable\n    import json\n    from pyspark.dbutils import DBUtils\n\n    if spark.catalog._jcatalog.tableExists(f"metadata.kafka_offsets"):\n        offset_dict = {}\n\n        for row in DeltaTable.forName(spark, f"metadata.kafka_offsets").toDF().collect():\n            if row["topic"] in offset_dict.keys():\n                offset_dict[row["topic"]].update({row["partition"] : row["max_offset"] + 1})\n            else:\n                offset_dict[row["topic"]] = {row["partition"] : row["max_offset"] + 1}\n\n        return (spark.read\\\n            .format("kafka")\\\n            .options(\n              **{\n                "kafka.sasl.jaas.config": (\n                  f"kafkashaded.org.apache.kafka.common.security.scram.ScramLoginModule"\n                  + f\' required username="{DBUtils(spark).secrets.get(scope = "test", key = "username")}" password="{DBUtils(spark).secrets.get(scope = "test", key = "password")}";\'\n                ),\n                "kafka.sasl.mechanism": "SCRAM-SHA-256",\n                "kafka.security.protocol": "SASL_SSL",\n                "kafka.bootstrap.servers": "broker1.aws.com:9094,broker2.aws.com:9094",\n                "kafka.session.timeout.ms": "6000",\n                "group.id": "group_id_1",\n                "subscribe": "my_first_topic,my_second_topic",\n                "startingOffsets": json.dumps(offset_dict),\n              }\n            )\\\n            .load()\\\n            .withColumn("value", col("value").cast("string"))\\\n            .withColumn("key", col("key").cast("string")))\n    else:\n        return (spark.read\\\n            .format("kafka")\\\n            .options(\n              **{\n                "kafka.sasl.jaas.config": (\n                  f"kafkashaded.org.apache.kafka.common.security.scram.ScramLoginModule"\n                  + f\' required username="{DBUtils(spark).secrets.get(scope = "test", key = "username")}" password="{DBUtils(spark).secrets.get(scope = "test", key = "password")}";\'\n                ),\n                "kafka.sasl.mechanism": "SCRAM-SHA-256",\n                "kafka.security.protocol": "SASL_SSL",\n                "kafka.bootstrap.servers": "broker1.aws.com:9094,broker2.aws.com:9094",\n                "kafka.session.timeout.ms": "6000",\n                "group.id": "group_id_1",\n                "subscribe": "my_first_topic,my_second_topic"\n              }\n            )\\\n            .load()\\\n            .withColumn("value", col("value").cast("string"))\\\n            .withColumn("key", col("key").cast("string")))\n\n')))),(0,n.yg)("hr",null),(0,n.yg)("h2",{id:"target"},"Target"),(0,n.yg)("p",null,"Writes each row from the Dataframe to Kafka topic(s) as JSON messages."),(0,n.yg)("h3",{id:"target-parameters"},"Target Parameters"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"left"},"Parameter"),(0,n.yg)("th",{parentName:"tr",align:"left"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"left"},"Required"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Broker List"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Comma separated list of Kafka brokers"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Security Protocol"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Security protocol for Kafka (Default value set to SASL_SSL)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"SASL Mechanism"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Default SASL Mechanism for SASL_SSL (Default value set to SCRAM-SHA-256)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Type"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Type provider (Databricks Secrets or Username/Password)"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Credential Scope"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Scope to use for Databricks secrets"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"Kafka Topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"Comma separated list of Kafka topics"),(0,n.yg)("td",{parentName:"tr",align:"left"},"True")))),(0,n.yg)("h3",{id:"target-example"},"Example"),(0,n.yg)("p",null,(0,n.yg)("img",{alt:"Example usage of Filter",src:a(24123).A,width:"3042",height:"1452"})),(0,n.yg)("h3",{id:"target-code"},"Generated Code"),(0,n.yg)(l.A,{mdxType:"Tabs"},(0,n.yg)(o.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-py"},'def KafkaTarget(spark: SparkSession, in0: DataFrame):\n    df1 = in0.select(to_json(struct("*")).alias("value"))\n    df2 = df1.selectExpr("CAST(value AS STRING)")\n    df2.write\\\n        .format("kafka")\\\n        .options(\n          **{\n            "kafka.sasl.jaas.config": (\n              f"kafkashaded.org.apache.kafka.common.security.scram.ScramLoginModule"\n              + f\' required username="{DBUtils(spark).secrets.get(scope = "test", key = "username")}" password="{DBUtils(spark).secrets.get(scope = "test", key = "password")}";\'\n            ),\n            "kafka.sasl.mechanism": "SCRAM-SHA-256",\n            "kafka.security.protocol": "SASL_SSL",\n            "kafka.bootstrap.servers": "broker1.aws.com:9094,broker2.aws.com:9094",\n            "topic": "my_first_topic,my_second_topic",\n          }\n        )\\\n        .save()\n\n')))),(0,n.yg)("h2",{id:"example-pipelines"},"Example pipelines"),(0,n.yg)("h3",{id:"source-pipeline-example"},"Source pipeline example"),(0,n.yg)("p",null,"In this example we'll read JSON messages from Kafka, parse them, remove any null messagesand then finally persist it to a Delta table."),(0,n.yg)("p",null,(0,n.yg)("img",{alt:"Example usage of Filter",src:a(47983).A,width:"1139",height:"584"})),(0,n.yg)("h4",{id:"metadata-table"},"Metadata Table"),(0,n.yg)("p",null,"In order to avoid reprocessing messages on subsequent pipeline runs, we're going to update a certain table with the last processed offsets for each Kafka partition and topic. The next time the pipeline runs this table will be used to only get a batch of messages that have arrived since the previously-processed offset."),(0,n.yg)("p",null,"For this example, we're going to update ",(0,n.yg)("inlineCode",{parentName:"p"},"metadata.kafka_offsets"),", which has the following structure:"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"left"},"topic"),(0,n.yg)("th",{parentName:"tr",align:"left"},"partition"),(0,n.yg)("th",{parentName:"tr",align:"left"},"max_offset"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"my_first_topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"0"),(0,n.yg)("td",{parentName:"tr",align:"left"},"10")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"my_first_topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"1"),(0,n.yg)("td",{parentName:"tr",align:"left"},"5")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"my_second_topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"0"),(0,n.yg)("td",{parentName:"tr",align:"left"},"10")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"left"},"my_second_topic"),(0,n.yg)("td",{parentName:"tr",align:"left"},"1"),(0,n.yg)("td",{parentName:"tr",align:"left"},"5")))),(0,n.yg)("p",null,"Taking this approach gives us the following benefits:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Build the pipeline interactively without committing any offsets"),(0,n.yg)("li",{parentName:"ol"},"Production workflows will only consume messages that have arrived since the previously-processed offset"),(0,n.yg)("li",{parentName:"ol"},"We can replay old messages by modifying the Metadata table")),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"For production workflows the ",(0,n.yg)("a",{parentName:"p",href:"/concepts/project/gems#phase"},"Phase")," for the ",(0,n.yg)("inlineCode",{parentName:"p"},"Script")," gem that updates the offsets should be greater than the Phase of the Target gem.\nThis is to ensure that offsets are only updated in the table after data is safely persisted to the Target.")),(0,n.yg)("h4",{id:"spark-code-used-for-script-component"},"Spark Code used for script component"),(0,n.yg)(l.A,{mdxType:"Tabs"},(0,n.yg)(o.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-py"},'def UpdateOffsets(spark: SparkSession, in0: DataFrame):\n\n    if not ("SColumnExpression" in locals()):\n        from delta.tables import DeltaTable\n        import pyspark.sql.functions as f\n        metadataTable = "metadata.kafka_offsets"\n        metaDataDf = in0.groupBy("partition", "topic").agg(f.max(f.col("`offset`").cast("int")).alias("max_offset"))\n\n        if not spark.catalog._jcatalog.tableExists(metadataTable):\n            metaDataDf.write.format("delta").mode("overwrite").saveAsTable(metadataTable)\n        else:\n            DeltaTable\\\n                .forName(spark, metadataTable)\\\n                .alias("target")\\\n                .merge(\n                  metaDataDf.alias("source"),\n                  (\n                    (col("source.`partition`") == col("target.`partition`"))\n                    & (col("source.`topic`") == col("target.`topic`"))\n                  )\n                )\\\n                .whenMatchedUpdateAll()\\\n                .whenNotMatchedInsertAll()\\\n                .execute()\n\n')))))}g.isMDXComponent=!0},47983:(e,t,a)=>{a.d(t,{A:()=>r});const r=a.p+"assets/images/kafka_pipeline_eg-f97290ea76491916f47acf312a5ea95b.gif"},38999:(e,t,a)=>{a.d(t,{A:()=>r});const r=a.p+"assets/images/kafka_source_eg_1-5d9b36695526379b9a62cf152b6170bf.png"},24123:(e,t,a)=>{a.d(t,{A:()=>r});const r=a.p+"assets/images/kafka_target_eg_1-498e2012164f661686168fbd52aebaaf.png"}}]);