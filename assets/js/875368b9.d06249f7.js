"use strict";(self.webpackChunkdocs_4=self.webpackChunkdocs_4||[]).push([[4473],{28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>o});var i=r(96540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},70582:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"Orchestration/databricks-jobs/automate-pipelines-databricks","title":"Run Prophecy pipelines in Databricks jobs","description":"Run Prophecy automate pipelines in Databricks.","source":"@site/docs/Orchestration/databricks-jobs/automate-pipelines-databricks.md","sourceDirName":"Orchestration/databricks-jobs","slug":"/engineers/automate-pipelines-databricks","permalink":"/engineers/automate-pipelines-databricks","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"jobs","permalink":"/tags/jobs"},{"inline":true,"label":"deployment","permalink":"/tags/deployment"},{"inline":true,"label":"orchestration","permalink":"/tags/orchestration"},{"inline":true,"label":"Databricks","permalink":"/tags/databricks"}],"version":"current","frontMatter":{"title":"Run Prophecy pipelines in Databricks jobs","id":"automate-pipelines-databricks","slug":"/engineers/automate-pipelines-databricks","description":"Run Prophecy automate pipelines in Databricks.","tags":["jobs","deployment","orchestration","Databricks"]},"sidebar":"platformSidebar","previous":{"title":"Databricks Jobs","permalink":"/engineers/databricks-jobs"},"next":{"title":"Alternative Schedulers","permalink":"/Orchestration/alternative-schedulers"}}');var t=r(74848),s=r(28453);const a={title:"Run Prophecy pipelines in Databricks jobs",id:"automate-pipelines-databricks",slug:"/engineers/automate-pipelines-databricks",description:"Run Prophecy automate pipelines in Databricks.",tags:["jobs","deployment","orchestration","Databricks"]},o=void 0,l={},c=[{value:"Create job",id:"create-job",level:2},{value:"Configure job",id:"configure-job",level:2},{value:"Add parameters",id:"add-parameters",level:3},{value:"Run and monitor",id:"run-and-monitor",level:3},{value:"View output",id:"view-output",level:3},{value:"Sample Python trigger file",id:"sample-python-trigger-file",level:2},{value:"Troubleshooting and common errors",id:"troubleshooting-and-common-errors",level:2},{value:"Missing or incorrect parameters",id:"missing-or-incorrect-parameters",level:3},{value:"Authentication errors",id:"authentication-errors",level:3},{value:"Compute or environment failures",id:"compute-or-environment-failures",level:3},{value:"Path errors",id:"path-errors",level:3},{value:"Output or log clarity",id:"output-or-log-clarity",level:3},{value:"Prophecy pipeline failures",id:"prophecy-pipeline-failures",level:3},{value:"Timeout or network errors",id:"timeout-or-network-errors",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["You can use Databricks Workflows to invoke a ",(0,t.jsx)(n.a,{href:"/administration/architecture#what-is-prophecy-automate",children:"Prophecy Automate pipeline"})," by running a small Python trigger script with the correct parameters (fabric ID, pipeline name, and project ID). This trigger script references Prophecy's ",(0,t.jsx)(n.a,{href:"/api/trigger-pipeline/trigger-pipeline-api",children:"Trigger Pipeline API"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"https://docs.databricks.com/aws/en/jobs/",children:"the Databricks job page"})," for more information on Databricks Workflows."]}),"\n",(0,t.jsx)(n.p,{children:"This lets you integrate Prophecy orchestration directly with Databricks job scheduling."}),"\n",(0,t.jsx)(n.admonition,{title:"Enterprise Only",type:"edition",children:(0,t.jsxs)(n.p,{children:["This deployment model requires the ",(0,t.jsx)(n.a,{href:"/getting-started/editions/",children:"Enterprise Edition"})," of Prophecy."]})}),"\n",(0,t.jsx)(n.h2,{id:"create-job",children:"Create job"}),"\n",(0,t.jsx)(n.p,{children:"To begin, create a job in Databricks:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Log in to Databricks and go to ",(0,t.jsx)(n.strong,{children:"Jobs & Pipelines"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Create new > Job"})," and give it a name, such as ",(0,t.jsx)(n.code,{children:"Compute Top Encounter [Trigger Demo]"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Under ",(0,t.jsx)(n.strong,{children:"Add your first task"}),", choose ",(0,t.jsx)(n.strong,{children:"Python script"}),". (If Python script does not display, choose ",(0,t.jsx)(n.strong,{children:"+ Add another task type"})," and select ",(0,t.jsx)(n.strong,{children:"Python script"})," in the dialog.)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"configure-job",children:"Configure job"}),"\n",(0,t.jsx)(n.p,{children:"In the dialog, configure the following parameters:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Field"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:["Task name ",(0,t.jsx)(n.strong,{children:"(Required)"})]}),(0,t.jsxs)(n.td,{children:["Enter a descriptive task name such as ",(0,t.jsx)(n.code,{children:"ProphecyRun"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:["Type ",(0,t.jsx)(n.strong,{children:"(Required)"})]}),(0,t.jsxs)(n.td,{children:["Select ",(0,t.jsx)(n.strong,{children:"Python script"}),". Should be pre-selected."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Source"}),(0,t.jsxs)(n.td,{children:["Choose ",(0,t.jsx)(n.strong,{children:"Workspace"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Path"}),(0,t.jsxs)(n.td,{children:["Provide the Databricks Workspace path to your Python trigger file, such as ",(0,t.jsx)(n.code,{children:"/Users/databricks-dev-e2@simpledatalabs.com/pipeline_trigger.py"}),". ",(0,t.jsx)("br",{}),"See ",(0,t.jsx)(n.a,{href:"#sample-python-trigger-file",children:"sample trigger file"})," below for an example of a Python trigger file.",(0,t.jsx)("br",{}),"For information on Databricks workspace files, see ",(0,t.jsx)(n.a,{href:"https://docs.databricks.com/aws/en/files/workspace",children:"What are workspace files?"})," in Databricks documentation."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Compute"}),(0,t.jsxs)(n.td,{children:["Select ",(0,t.jsx)(n.strong,{children:"Serverless (Autoscaling)"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Environment and Libraries"}),(0,t.jsxs)(n.td,{children:["Leave as ",(0,t.jsx)(n.strong,{children:"Default"})," unless you need custom libraries."]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"add-parameters",children:"Add parameters"}),"\n",(0,t.jsx)(n.p,{children:"Next, you'll add parameters to the job. These identify which Prophecy pipeline to trigger."}),"\n",(0,t.jsx)(n.p,{children:"They are passed to the script as runtime arguments:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'["--fabric-id", "213",\n"--pipeline-name", "top_encounters",\n"--project-id", "297"]\n'})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Explanation"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"fabric-id"})}),(0,t.jsxs)(n.td,{children:["Identifies the Prophecy Fabric environment (such as ",(0,t.jsx)(n.code,{children:"dev"}),", ",(0,t.jsx)(n.code,{children:"staging"}),", ",(0,t.jsx)(n.code,{children:"prod"}),")."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"pipeline-name"})}),(0,t.jsx)(n.td,{children:"The specific Prophecy pipeline to run."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"project-id"})}),(0,t.jsx)(n.td,{children:"The project within which that pipeline is defined."})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"run-and-monitor",children:"Run and monitor"}),"\n",(0,t.jsx)(n.p,{children:"You can now run the job."}),"\n",(0,t.jsx)(n.p,{children:"Running invokes the actual job run in Databricks\u2019 workflow engine.\nOnce you have confirmed that the job runs correctly, you can set a schedule in the Databricks UI to run it automatically."}),"\n",(0,t.jsx)(n.p,{children:"In Databricks:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the ",(0,t.jsx)(n.strong,{children:"Runs"})," tab and click ",(0,t.jsx)(n.strong,{children:"Run now"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Open the job once it is available.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"If errors occur, the logs will display the failing component."}),"\n",(0,t.jsx)(n.li,{children:"Links in the output allow you to open the pipeline in Prophecy for debugging."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"view-output",children:"View output"}),"\n",(0,t.jsx)(n.p,{children:"Databricks displays information on the job's output."}),"\n",(0,t.jsx)(n.p,{children:"Sample output is as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Prophecy Pipeline Trigger Status:\nSuccess: True\nRun ID: MDAwMDAwMDAzNzg4LTQyNmZMjML==\nMessage: Pipeline triggered successfully.\n\nRun progress:\n2025-11-04 18:56:24 UTC: RUNNING\n2025-11-04 18:56:24 UTC: SUCCEEDED\n\nPipeline completed successfully!\nYou can see the pipeline here:\nhttps://analytics.prophecy.io/metadata/sql/297?entity=Pipeline&name=top_encounters\nSee the runs here:\nhttps://analytics.prophecy.io/metadata/ide/observation?observationTab=run-history&project\n"})}),"\n",(0,t.jsx)(n.h2,{id:"sample-python-trigger-file",children:"Sample Python trigger file"}),"\n",(0,t.jsx)(n.p,{children:"An example of a Python trigger file appears below. The following code:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Authenticates with the Prophecy API using a Prophecy token."}),"\n",(0,t.jsx)(n.li,{children:"Triggers a pipeline in a given project, fabric, and branch."}),"\n",(0,t.jsx)(n.li,{children:"Polls the pipeline\u2019s run status until it finishes."}),"\n",(0,t.jsx)(n.li,{children:"Prints direct links to the pipeline and its run history."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import requests\nimport argparse\nimport time\nfrom datetime import datetime\n\n# Constants\nBASE_URL = "https://analytics.prophecy.io"\nAPI_TOKEN = dbutils.secrets.get("myusername", "prophecy_analytics_token")\n\ndef get_headers():\n    return {"X-AUTH-TOKEN": API_TOKEN, "Content-Type": "application/json"}\n\ndef print_links(project_id, pipeline_name, fabric_id):\n    print(f"\\nView pipeline: {BASE_URL}/metadata/sql/{project_id}?entity=pipeline&name={pipeline_name}")\n    print(f"View runs: {BASE_URL}/metadata/ide/observation?observationTab=run-history&prFabricId={fabric_id}&prProjectId={project_id}")\n\ndef parse_args():\n    parser = argparse.ArgumentParser(description="Trigger a Prophecy pipeline")\n    parser.add_argument("--fabric-id", type=int, required=True)\n    parser.add_argument("--pipeline-name", required=True)\n    parser.add_argument("--project-id", required=True)\n    parser.add_argument("--branch", default="dev")\n    return parser.parse_args()\n\nargs = parse_args()\n\n# Trigger the pipeline\ntrigger_url = f"{BASE_URL}/api/trigger/pipeline"\npayload = {\n    "fabricId": args.fabric_id,\n    "pipelineName": args.pipeline_name,\n    "branch": args.branch,\n    "projectId": args.project_id\n}\nresponse = requests.post(trigger_url, headers=get_headers(), json=payload).json()\n\nprint("\\nPipeline Triggered:")\nprint(f"  Success: {response[\'success\']}")\nprint(f"  Run ID: {response[\'runId\']}")\nprint(f"  Message: {response[\'msg\']}\\n")\n\n# Poll until completion\nprint("Run Progress:")\nwhile True:\n    while True:\n    # Get current run status\n    status_url = f"{BASE_URL}/api/trigger/pipeline/{response_trigger[\'runId\']}"\n    response_status = requests.get(status_url, headers=get_headers()).json()\n\n    # Extract and format status information\n    status = response_status[\'runStatus\']\n    # Convert UTC timestamp to local timezone\n    utc_timestamp = datetime.fromisoformat(response_status[\'updatedAt\'].replace(\'Z\', \'+00:00\'))\n    local_timestamp = utc_timestamp.astimezone()\n    formatted_timestamp = local_timestamp.strftime(\'%Y-%m-%d %H:%M:%S %Z\')\n\n    # Print current status with local timestamp\n    print(f"    {formatted_timestamp}: {status}")\n\n    # Handle error case\n    if status == \'ERROR\':\n        error = f"\\nPipeline failed: {response_status[\'errorMessage\']}"\n        print(error)\n        print_pipeline_links(args.project_id, args.pipeline_name, args.fabric_id)\n        raise Exception(error)\n    # Handle successful completion\n    elif status != \'RUNNING\':\n        print("\\nPipeline completed successfully!")\n        break\n\n    # Wait before checking status again\n    time.sleep(0.5)\n\n# Print final links for reference\nprint_pipeline_links(args.project_id, args.pipeline_name, args.fabric_id)\n\n'})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting-and-common-errors",children:"Troubleshooting and common errors"}),"\n",(0,t.jsx)(n.p,{children:"If your trigger job fails or doesn\u2019t start the Prophecy pipeline as expected, review the following common issues:"}),"\n",(0,t.jsx)(n.h3,{id:"missing-or-incorrect-parameters",children:"Missing or incorrect parameters"}),"\n",(0,t.jsx)(n.p,{children:"Make sure your parameters match the exact Prophecy project and pipeline:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"--fabric-id 213\n--pipeline-name top_encounters\n--project-id 297\n"})}),"\n",(0,t.jsx)(n.p,{children:"If any of these are incorrect (for example, the wrong fabric ID), the trigger script will run but the pipeline will not start."}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can confirm your fabric and project IDs in Prophecy under ",(0,t.jsx)(n.strong,{children:"Metadata > Fabrics"})," and ",(0,t.jsx)(n.strong,{children:"Metadata > Projects"}),". When you open the entity's metadata page, you'll find the ID in the URL."]})}),"\n",(0,t.jsx)(n.h3,{id:"authentication-errors",children:"Authentication errors"}),"\n",(0,t.jsx)(n.p,{children:"If you see an authentication or permissions error:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Ensure that your Prophecy API token is valid."}),"\n",(0,t.jsx)(n.li,{children:"Ensure the user running the job has both Databricks and Prophecy credentials set up (via API token or linked integration)."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"compute-or-environment-failures",children:"Compute or environment failures"}),"\n",(0,t.jsx)(n.p,{children:"If the job never starts:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Check that ",(0,t.jsx)(n.strong,{children:"Compute"})," is set to ",(0,t.jsx)(n.strong,{children:"Serverless (Autoscaling)"})," or a valid cluster."]}),"\n",(0,t.jsxs)(n.li,{children:["If your workspace doesn\u2019t support Serverless, choose a specific ",(0,t.jsx)(n.strong,{children:"existing cluster"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"path-errors",children:"Path errors"}),"\n",(0,t.jsx)(n.p,{children:"If Databricks cannot locate the trigger script:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Make sure the ",(0,t.jsx)(n.strong,{children:"Path"})," field matches the full path in the Databricks repository."]}),"\n",(0,t.jsxs)(n.li,{children:["Example:\n",(0,t.jsx)(n.code,{children:"/Users/databricks-dev-e2@simpledatalabs.com/pipeline_trigger.py"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"output-or-log-clarity",children:"Output or log clarity"}),"\n",(0,t.jsx)(n.p,{children:"If the job completes but you\u2019re not sure whether the pipeline ran:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check the job\u2019s ",(0,t.jsx)(n.strong,{children:"Output"})," tab. Successful runs include confirmation such as:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Success: True\nMessage: Pipeline triggered successfully.\n"})}),"\n",(0,t.jsx)(n.p,{children:"You can click the pipeline link in the output to open it directly in Prophecy for verification and debugging."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"prophecy-pipeline-failures",children:"Prophecy pipeline failures"}),"\n",(0,t.jsx)(n.p,{children:"If the Databricks job succeeds but the pipeline itself fails:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the Prophecy pipeline linked in ",(0,t.jsx)(n.a,{href:"#view-output",children:"the output log"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Identify the failed gem."}),"\n",(0,t.jsx)(n.li,{children:"Review Prophecy validation output for the gem fix the specific component."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"timeout-or-network-errors",children:"Timeout or network errors"}),"\n",(0,t.jsx)(n.p,{children:"If execution hangs:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Check Databricks workspace connectivity to Prophecy\u2019s API endpoint."}),"\n",(0,t.jsx)(n.li,{children:"Increase the job timeout in Databricks if the trigger script is waiting for confirmation of a long-running Prophecy job."}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);