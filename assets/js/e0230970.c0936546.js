"use strict";(self.webpackChunkdocs_4=self.webpackChunkdocs_4||[]).push([[88217],{15680:(e,t,a)=>{a.d(t,{xA:()=>u,yg:()=>y});var r=a(96540);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var p=r.createContext({}),s=function(e){var t=r.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},d="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=s(a),c=n,y=d["".concat(p,".").concat(c)]||d[c]||g[c]||o;return a?r.createElement(y,i(i({ref:t},u),{},{components:a})):r.createElement(y,i({ref:t},u))}));function y(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[d]="string"==typeof e?e:n,i[1]=l;for(var s=2;s<o;s++)i[s]=a[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}c.displayName="MDXCreateElement"},7843:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>g,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var r=a(58168),n=(a(96540),a(15680));const o={title:"Upgrades and backups",id:"upgrade-backup-restore",description:"Learn how to upgrade, back up, and restore Prophecy.",sidebar_position:4,tags:["upgrade","backup","restore","self-managed"]},i=void 0,l={unversionedId:"architecture/self-hosted/upgrade-backup-restore",id:"architecture/self-hosted/upgrade-backup-restore",title:"Upgrades and backups",description:"Learn how to upgrade, back up, and restore Prophecy.",source:"@site/docs/architecture/self-hosted/upgrade-backup-restore.md",sourceDirName:"architecture/self-hosted",slug:"/architecture/self-hosted/upgrade-backup-restore",permalink:"/architecture/self-hosted/upgrade-backup-restore",draft:!1,tags:[{label:"upgrade",permalink:"/tags/upgrade"},{label:"backup",permalink:"/tags/backup"},{label:"restore",permalink:"/tags/restore"},{label:"self-managed",permalink:"/tags/self-managed"}],version:"current",sidebarPosition:4,frontMatter:{title:"Upgrades and backups",id:"upgrade-backup-restore",description:"Learn how to upgrade, back up, and restore Prophecy.",sidebar_position:4,tags:["upgrade","backup","restore","self-managed"]},sidebar:"mySidebar",previous:{title:"Sandbox Configuration",permalink:"/architecture/self-hosted/configurations/sandbox-configuration"},next:{title:"Download logs",permalink:"/architecture/self-hosted/download-logs"}},p={},s=[{value:"Upgrade",id:"upgrade",level:2},{value:"Backup",id:"backup",level:2},{value:"On-demand backups",id:"on-demand-backups",level:3},{value:"Regular automatic backups",id:"regular-automatic-backups",level:3},{value:"Additional backup APIs",id:"additional-backup-apis",level:3},{value:"Restore",id:"restore",level:2},{value:"On-demand restore",id:"on-demand-restore",level:3},{value:"Additional restore APIs",id:"additional-restore-apis",level:3},{value:"Backup and restore guidelines",id:"backup-and-restore-guidelines",level:2},{value:"Migrate to different cluster",id:"migrate-to-different-cluster",level:2}],u={toc:s},d="wrapper";function g(e){let{components:t,...o}=e;return(0,n.yg)(d,(0,r.A)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("p",null,"This page outlines different actions you may perform to maintain your Prophecy installation."),(0,n.yg)("h2",{id:"upgrade"},"Upgrade"),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"You may want to back up Prophecy before you upgrade.")),(0,n.yg)("p",null,"To upgrade Prophecy, you can do so in ",(0,n.yg)("strong",{parentName:"p"},"Settings > Admin"),"."),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Navigate to the ",(0,n.yg)("strong",{parentName:"li"},"Admin")," tab of the Prophecy ",(0,n.yg)("strong",{parentName:"li"},"Settings")," page."),(0,n.yg)("li",{parentName:"ol"},"Click on ",(0,n.yg)("strong",{parentName:"li"},"Upgrade Version"),"."),(0,n.yg)("li",{parentName:"ol"},"Choose the version you would like to upgrade to in the ",(0,n.yg)("strong",{parentName:"li"},"Version")," dropdown."),(0,n.yg)("li",{parentName:"ol"},"Make sure that ",(0,n.yg)("strong",{parentName:"li"},"Disable Rollback")," toggle is on.")),(0,n.yg)("p",null,(0,n.yg)("img",{alt:"Upgrade version in Admin settings",src:a(32620).A,width:"2620",height:"1511"})),(0,n.yg)("h2",{id:"backup"},"Backup"),(0,n.yg)("p",null,"Backups can be triggered manually via the API, or they can be configured to run automatically."),(0,n.yg)("admonition",{type:"info"},(0,n.yg)("p",{parentName:"admonition"},"Backup storage depends on ",(0,n.yg)("a",{parentName:"p",href:"/architecture/self-hosted/configurations/configure-object-store"},"object store configurations"),". Make sure to configure these before proceeding below.")),(0,n.yg)("h3",{id:"on-demand-backups"},"On-demand backups"),(0,n.yg)("p",null,"You can use the Backup API to start a backup. See ",(0,n.yg)("a",{parentName:"p",href:"./generate-api-key/"},"Generate API Key")," if you need an API key."),(0,n.yg)("p",null,"Example:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},"curl --location --request POST 'https://{prophecy-url}/api/backup' \\\n--header 'Cookie: prophecy-token={api-key}' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{}'\n")),(0,n.yg)("p",null,"Response:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},'{\n"code": 202,\n"message": "Request Accepted with timestamp 2023-02-02t16-00-00"\n}\n')),(0,n.yg)("h3",{id:"regular-automatic-backups"},"Regular automatic backups"),(0,n.yg)("p",null,"You can configure regular backups in Prophecy in settings."),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Log in to Prophecy as an admin user."),(0,n.yg)("li",{parentName:"ol"},"Click on the three dots at the bottom left corner."),(0,n.yg)("li",{parentName:"ol"},"Navigate to ",(0,n.yg)("strong",{parentName:"li"},"Settings > Admin > Config > backupConfig"),"."),(0,n.yg)("li",{parentName:"ol"},"Make sure ",(0,n.yg)("inlineCode",{parentName:"li"},"enableRegularBackups")," is set to true."),(0,n.yg)("li",{parentName:"ol"},"Edit other variables to fit your requirements."),(0,n.yg)("li",{parentName:"ol"},"Save your changes.")),(0,n.yg)("p",null,"Below is a list of supported variables that you can change."),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:null},"Configuration variable name"),(0,n.yg)("th",{parentName:"tr",align:null},"Description"),(0,n.yg)("th",{parentName:"tr",align:null},"Default value"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"backupFrequency")),(0,n.yg)("td",{parentName:"tr",align:null},"How frequently to purge old user events from the internal database. Defaults to daily at 00:00. Uses ",(0,n.yg)("a",{parentName:"td",href:"https://pkg.go.dev/github.com/robfig/cron#hdr-CRON_Expression_Format"},"6-digit CRON")),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"0 0 0 * * *"))),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"backupRetentionCount")),(0,n.yg)("td",{parentName:"tr",align:null},"Number of last ",(0,n.yg)("inlineCode",{parentName:"td"},"N")," backups to retain."),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"30"))),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"enableRegularBackups")),(0,n.yg)("td",{parentName:"tr",align:null},"State of automated backup creation."),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"false"))))),(0,n.yg)("h3",{id:"additional-backup-apis"},"Additional backup APIs"),(0,n.yg)("p",null,"Here is a list of additional APIs for backups. One sample call may look like:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"}," curl --location --request POST 'https://{prophecy-url}/api/backup' \\\n --header 'Cookie: prophecy-token={api-key}' \\\n --header 'Content-Type: application/json' \\\n --data-raw '{}'\n")),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:null},"API"),(0,n.yg)("th",{parentName:"tr",align:null},"Description"),(0,n.yg)("th",{parentName:"tr",align:null},"Parameters"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("strong",{parentName:"td"},"GET")," ",(0,n.yg)("inlineCode",{parentName:"td"},"https://{prophecy-url}/api/backup/latest")),(0,n.yg)("td",{parentName:"tr",align:null},"This API returns the status current/last backup operation triggered."),(0,n.yg)("td",{parentName:"tr",align:null},"None expected")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("strong",{parentName:"td"},"GET")," ",(0,n.yg)("inlineCode",{parentName:"td"},"https://{prophecy-url}/api/backup/status")),(0,n.yg)("td",{parentName:"tr",align:null},"This API returns the status of the backup with a certain timestamp. If there is no timestamp passed and there is an ongoing backup, the status for ongoing backup is returned."),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"timestamp"))),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("strong",{parentName:"td"},"GET")," ",(0,n.yg)("inlineCode",{parentName:"td"},"https://{prophecy-url}/api/backup/list")),(0,n.yg)("td",{parentName:"tr",align:null},"This API returns the list of available backups."),(0,n.yg)("td",{parentName:"tr",align:null},"None expected")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("strong",{parentName:"td"},"GET")," ",(0,n.yg)("inlineCode",{parentName:"td"},"https://{prophecy-url}/api/backup/delete")),(0,n.yg)("td",{parentName:"tr",align:null},"This API attempts the delete the backup data (local and upstream) and also the metadata (database entries) associated with it. Note that in case of ",(0,n.yg)("inlineCode",{parentName:"td"},"enableRegularBackups")," set to true, backups are older than ",(0,n.yg)("inlineCode",{parentName:"td"},"backupRetentionCount")," in reverse order are garbage collected automatically."),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"timestamp"))))),(0,n.yg)("h2",{id:"restore"},"Restore"),(0,n.yg)("p",null,"Restore is an on-demand based overwrite of the whole Prophecy configuration to reflect the state of a particular backup.\nThe restore operation always assumes a running destination Prophecy cluster where the data and the configuration of source cluster will be restored."),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"If backup was taken in Athena's local Persistent Volume, it needs to be copied to Athena's Persistent Volume in the destination cluster before the restore operation can be performed.")),(0,n.yg)("h3",{id:"on-demand-restore"},"On-demand restore"),(0,n.yg)("p",null,"You can restore using the Restore API. See ",(0,n.yg)("a",{parentName:"p",href:"./generate-api-key/"},"Generate API Key")," if you need an API key."),(0,n.yg)("admonition",{type:"danger"},(0,n.yg)("p",{parentName:"admonition"},"This API should be used with extreme caution as triggering this will lead to loss of current state/data.")),(0,n.yg)("p",null,"The below API is used to trigger a restore operation. It expects one parameter which is the ",(0,n.yg)("inlineCode",{parentName:"p"},"timestamp")," of a successful backup."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},"curl --location --request POST 'https://{prophecy-url}/api/restore' \\\n--header 'Cookie: prophecy-token={api-key}' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    \"timestamp\": \"2022-11-22t10-00-00\",\n    \"sourceNamespace\": \"{Source cluster controlplane namespace}\"\n}'\n")),(0,n.yg)("p",null,"Sample API call with disable of gitserver restore. You may use similar options for ",(0,n.yg)("inlineCode",{parentName:"p"},"artifactory")," / ",(0,n.yg)("inlineCode",{parentName:"p"},"edweb")," / ",(0,n.yg)("inlineCode",{parentName:"p"},"metagraph")," / ",(0,n.yg)("inlineCode",{parentName:"p"},"openidfederator"),"."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},'curl --location --request POST \'https://{prophecy-url}/api/restore\' \\\n--header \'Cookie: prophecy-token={api-key}\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n    "timestamp": "2022-11-22t10-00-00",\n    "sourceNamespace": "{Source cluster controlplane namespace}",\n    "svcs": {\n        "gitserver": {\n            "disable": false\n        },\n    }\n}\'\n')),(0,n.yg)("p",null,"In the above API:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"timestamp")," is the timestamp of the backup to use to perform the restore"),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"sourceNamespace")," is the namespace in which source cluster's control plane was installed."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"svcs"),": This JSON object needs to be set only when you wish to skip restore of any particular service by setting ",(0,n.yg)("inlineCode",{parentName:"li"},"disabled")," as ",(0,n.yg)("inlineCode",{parentName:"li"},"true"),". Otherwise, you can skip ",(0,n.yg)("inlineCode",{parentName:"li"},"svcs")," field entirely.")),(0,n.yg)("p",null,"Sample response"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},'{\n    "code": 202,\n    "message": "Request Accepted"\n}\n')),(0,n.yg)("h3",{id:"additional-restore-apis"},"Additional restore APIs"),(0,n.yg)("p",null,"Here is a list of additional APIs for restore. One sample call may look like:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre"},"curl --location --request POST 'https://{prophecy-url}/api/backup'\n--header 'Cookie: prophecy-token={api-key}'\n--header 'Content-Type: application/json'\n--data-raw '{}'\n")),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:null},"API"),(0,n.yg)("th",{parentName:"tr",align:null},"Description"),(0,n.yg)("th",{parentName:"tr",align:null},"Parameters"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("strong",{parentName:"td"},"GET")," ",(0,n.yg)("inlineCode",{parentName:"td"},"https://{prophecy-url}/api/restore/status")),(0,n.yg)("td",{parentName:"tr",align:null},"This API returns the status of the restore operation with a certain timestamp. If there is no timestamp passed and there is an ongoing restore, the status for the ongoing restore is returned."),(0,n.yg)("td",{parentName:"tr",align:null},(0,n.yg)("inlineCode",{parentName:"td"},"timestamp"))))),(0,n.yg)("h2",{id:"backup-and-restore-guidelines"},"Backup and restore guidelines"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Take backups regularly, preferably to cloud storage."),(0,n.yg)("li",{parentName:"ol"},"Create a Disaster Recovery Kubernetes in a different region."),(0,n.yg)("li",{parentName:"ol"},"Install Prophecy in the remote Kubernetes and keep it in standby. In other words, scale down all pods."),(0,n.yg)("li",{parentName:"ol"},"Disaster Recovery restore can be initiated from the remote region when the primary goes down."),(0,n.yg)("li",{parentName:"ol"},"Once the restore is done, the Disaster Recovery site is available for work to continue.")),(0,n.yg)("h2",{id:"migrate-to-different-cluster"},"Migrate to different cluster"),(0,n.yg)("p",null,"If there is a requirement to migrate to a different Kubernetes cluster, you can leverage the backups for that:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Create a new Kubernetes cluster and install Prophecy based on Prophecy installation requirements."),(0,n.yg)("li",{parentName:"ol"},"Back up the source cluster."),(0,n.yg)("li",{parentName:"ol"},"Restore the backup into new cluster."),(0,n.yg)("li",{parentName:"ol"},"Check that everything works as expected."),(0,n.yg)("li",{parentName:"ol"},"Plan a downtime for the source cluster, initiate a fresh backup and restore it to the new cluster."),(0,n.yg)("li",{parentName:"ol"},"If the new cluster needs to use the old DNS, the DNS entry of old cluster should point to new cluster's ",(0,n.yg)("inlineCode",{parentName:"li"},"Loadbalancer")," and the ",(0,n.yg)("inlineCode",{parentName:"li"},"Ingress")," of the new cluster needs to be changed to use the old name. Contact support if you require assistance with these steps.")))}g.isMDXComponent=!0},32620:(e,t,a)=>{a.d(t,{A:()=>r});const r=a.p+"assets/images/upgrade-version-299aa03df5d926f970f23f9a7c43e102.png"}}]);