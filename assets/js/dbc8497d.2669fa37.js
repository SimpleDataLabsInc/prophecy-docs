"use strict";(self.webpackChunkdocs_4=self.webpackChunkdocs_4||[]).push([[16980],{15680:(e,t,a)=>{a.d(t,{xA:()=>m,yg:()=>g});var n=a(96540);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=p(a),c=o,g=d["".concat(s,".").concat(c)]||d[c]||u[c]||r;return a?n.createElement(g,i(i({ref:t},m),{},{components:a})):n.createElement(g,i({ref:t},m))}));function g(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},19365:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(96540),o=a(20053);const r={tabItem:"tabItem_Ymn6"};function i(e){let{children:t,hidden:a,className:i}=e;return n.createElement("div",{role:"tabpanel",className:(0,o.A)(r.tabItem,i),hidden:a},t)}},11470:(e,t,a)=>{a.d(t,{A:()=>N});var n=a(58168),o=a(96540),r=a(20053),i=a(23104),l=a(56347),s=a(57485),p=a(31682),m=a(89466);function d(e){return function(e){return o.Children.map(e,(e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:a,attributes:n,default:o}}=e;return{value:t,label:a,attributes:n,default:o}}))}function u(e){const{values:t,children:a}=e;return(0,o.useMemo)((()=>{const e=t??d(a);return function(e){const t=(0,p.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function c(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:a}=e;const n=(0,l.W6)(),r=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,s.aZ)(r),(0,o.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(n.location.search);t.set(r,e),n.replace({...n.location,search:t.toString()})}),[r,n])]}function y(e){const{defaultValue:t,queryString:a=!1,groupId:n}=e,r=u(e),[i,l]=(0,o.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!c({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const n=a.find((e=>e.default))??a[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:r}))),[s,p]=g({queryString:a,groupId:n}),[d,y]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[n,r]=(0,m.Dv)(a);return[n,(0,o.useCallback)((e=>{a&&r.set(e)}),[a,r])]}({groupId:n}),h=(()=>{const e=s??d;return c({value:e,tabValues:r})?e:null})();(0,o.useLayoutEffect)((()=>{h&&l(h)}),[h]);return{selectedValue:i,selectValue:(0,o.useCallback)((e=>{if(!c({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);l(e),p(e),y(e)}),[p,y,r]),tabValues:r}}var h=a(92303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function b(e){let{className:t,block:a,selectedValue:l,selectValue:s,tabValues:p}=e;const m=[],{blockElementScrollPositionUntilNextRender:d}=(0,i.a_)(),u=e=>{const t=e.currentTarget,a=m.indexOf(t),n=p[a].value;n!==l&&(d(t),s(n))},c=e=>{let t=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const a=m.indexOf(e.currentTarget)+1;t=m[a]??m[0];break}case"ArrowLeft":{const a=m.indexOf(e.currentTarget)-1;t=m[a]??m[m.length-1];break}}t?.focus()};return o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":a},t)},p.map((e=>{let{value:t,label:a,attributes:i}=e;return o.createElement("li",(0,n.A)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>m.push(e),onKeyDown:c,onClick:u},i,{className:(0,r.A)("tabs__item",f.tabItem,i?.className,{"tabs__item--active":l===t})}),a??t)})))}function v(e){let{lazy:t,children:a,selectedValue:n}=e;const r=(Array.isArray(a)?a:[a]).filter(Boolean);if(t){const e=r.find((e=>e.props.value===n));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return o.createElement("div",{className:"margin-top--md"},r.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==n}))))}function w(e){const t=y(e);return o.createElement("div",{className:(0,r.A)("tabs-container",f.tabList)},o.createElement(b,(0,n.A)({},e,t)),o.createElement(v,(0,n.A)({},e,t)))}function N(e){const t=(0,h.A)();return o.createElement(w,(0,n.A)({key:String(t)},e))}},54739:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>m,contentTitle:()=>s,default:()=>g,frontMatter:()=>l,metadata:()=>p,toc:()=>d});var n=a(58168),o=(a(96540),a(15680)),r=a(11470),i=a(19365);const l={title:"Gem Builder for Spark",id:"spark-gem-builder",description:"Build Spark gems in Python or Scala",tags:["gem builder"]},s=void 0,p={unversionedId:"extensibility/gem-builder/spark-gem-builder",id:"extensibility/gem-builder/spark-gem-builder",title:"Gem Builder for Spark",description:"Build Spark gems in Python or Scala",source:"@site/docs/extensibility/gem-builder/spark-gem-builder.md",sourceDirName:"extensibility/gem-builder",slug:"/extensibility/gem-builder/spark-gem-builder",permalink:"/extensibility/gem-builder/spark-gem-builder",draft:!1,tags:[{label:"gem builder",permalink:"/tags/gem-builder"}],version:"current",frontMatter:{title:"Gem Builder for Spark",id:"spark-gem-builder",description:"Build Spark gems in Python or Scala",tags:["gem builder"]},sidebar:"mySidebar",previous:{title:"Gem Builder for SQL",permalink:"/extensibility/gem-builder/sql-gem-builder"},next:{title:"Optimization functions",permalink:"/extensibility/gem-builder/optimization-functions"}},m={},d=[{value:"Overview",id:"overview",level:2},{value:"Gem mode",id:"gem-mode",level:2},{value:"Gem template",id:"gem-template",level:2},{value:"Tutorial",id:"tutorial",level:2},{value:"Create a gem",id:"create-a-gem",level:3},{value:"Update header",id:"update-header",level:3},{value:"Extend parent class",id:"extend-parent-class",level:3},{value:"Populate properties class",id:"populate-properties-class",level:3},{value:"Create UI components",id:"create-ui-components",level:3},{value:"Validate user input",id:"validate-user-input",level:3},{value:"Define state changes",id:"define-state-changes",level:3},{value:"Serialize or deserialize",id:"serialize-or-deserialize",level:3},{value:"Define Spark logic",id:"define-spark-logic",level:3},{value:"Extend functionality",id:"extend-functionality",level:2},{value:"Extend UI",id:"extend-ui",level:3},{value:"Extend the Component Code with functions",id:"extend-the-component-code-with-functions",level:3},{value:"Extend the read/write capabilities with Dataset Format Gems",id:"extend-the-readwrite-capabilities-with-dataset-format-gems",level:3},{value:"Troubleshoot errors",id:"troubleshoot-errors",level:2},{value:"What&#39;s next?",id:"whats-next",level:2}],u={toc:d},c="wrapper";function g(e){let{components:t,...l}=e;return(0,o.yg)(c,(0,n.A)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,o.yg)("p",null,(0,o.yg)("a",{parentName:"p",href:"/concepts/project/gems"},"Gems")," are visually-packaged parcels of code that perform specific operations on data. While Prophecy provides many gems out of the box, Prophecy also lets you create your own gems! Not only can you create new gems, but you can also share them in the ",(0,o.yg)("a",{parentName:"p",href:"/extensibility/package-hub/"},"Package Hub")," or with selected teams."),(0,o.yg)("h2",{id:"overview"},"Overview"),(0,o.yg)("p",null,"Let's learn how to create a Spark gem. At a high level, this involves the following steps:"),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Create a Spark project in which you will create your custom gem."),(0,o.yg)("li",{parentName:"ol"},"Add a gem to the Gems section of the project sidebar."),(0,o.yg)("li",{parentName:"ol"},"Specify the name and type of gem that you want to create."),(0,o.yg)("li",{parentName:"ol"},"Write your code specifications."),(0,o.yg)("li",{parentName:"ol"},"Preview the rendered visual interface of your gem."),(0,o.yg)("li",{parentName:"ol"},"Fill in some values and review the generated code.")),(0,o.yg)("admonition",{type:"note"},(0,o.yg)("p",{parentName:"admonition"},"If you plan to share these gems in a package, be aware that everything in the project (pipelines, subgraphs, jobs, etc.) will be part of the package, too.")),(0,o.yg)("p",null,"Next, we will review these steps in greater detail."),(0,o.yg)("h2",{id:"gem-mode"},"Gem mode"),(0,o.yg)("p",null,"There are a few different types of gems that you can create. The table below describes each mode you can choose."),(0,o.yg)("table",null,(0,o.yg)("thead",{parentName:"table"},(0,o.yg)("tr",{parentName:"thead"},(0,o.yg)("th",{parentName:"tr",align:null},"Mode"),(0,o.yg)("th",{parentName:"tr",align:null},"Description"),(0,o.yg)("th",{parentName:"tr",align:null},"Additional settings"))),(0,o.yg)("tbody",{parentName:"table"},(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Transformation"),(0,o.yg)("td",{parentName:"tr",align:null},"Edits intermediate data in the pipeline that is in-memory."),(0,o.yg)("td",{parentName:"tr",align:null},"Choose the ",(0,o.yg)("strong",{parentName:"td"},"category")," of the transformation gem")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Dataset Format"),(0,o.yg)("td",{parentName:"tr",align:null},"Reads and writes data between storage and memory."),(0,o.yg)("td",{parentName:"tr",align:null},"Choose whether the type is ",(0,o.yg)("strong",{parentName:"td"},"batch")," or ",(0,o.yg)("strong",{parentName:"td"},"streaming"))),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Custom Subgraph (",(0,o.yg)("strong",{parentName:"td"},"Python only"),")"),(0,o.yg)("td",{parentName:"tr",align:null},"Controls the flow of gems. Visit the ",(0,o.yg)("a",{parentName:"td",href:"/Spark/gems/subgraph/"},"Subgraph")," page for an example."),(0,o.yg)("td",{parentName:"tr",align:null},"None")))),(0,o.yg)("h2",{id:"gem-template"},"Gem template"),(0,o.yg)("p",null,"Each type of gem will have a different code template that Prophecy provides. Let's review the template of a ",(0,o.yg)("strong",{parentName:"p"},"transformation")," gem."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},'from prophecy.cb.server.base.ComponentBuilderBase import *\nfrom pyspark.sql import *\nfrom pyspark.sql.functions import *\n\nfrom prophecy.cb.server.base import WorkflowContext\nfrom prophecy.cb.server.base.datatypes import SInt, SString\nfrom prophecy.cb.ui.uispec import *\n\n\nclass CustomLimit(ComponentSpec):\n    name: str = "CustomLimit"\n    category: str = "Transform"\n\n    def optimizeCode(self) -> bool:\n        # Return whether code optimization is enabled for this component\n        return True\n\n    @dataclass(frozen=True)\n    class CustomLimitProperties(ComponentProperties):\n        # properties for the component with default values\n        my_property: SString = SString("default value of my property")\n\n    def dialog(self) -> Dialog:\n        # Define the UI dialog structure for the component\n        return Dialog("CustomLimit")\n\n    def validate(self, context: WorkflowContext, component: Component[CustomLimitProperties]) -> List[Diagnostic]:\n        # Validate the component\'s state\n        return []\n\n    def onChange(self, context: WorkflowContext, oldState: Component[CustomLimitProperties], newState: Component[CustomLimitProperties]) -> Component[\n    CustomLimitProperties]:\n        # Handle changes in the component\'s state and return the new state\n        return newState\n\n\n    class CustomLimitCode(ComponentCode):\n        def __init__(self, newProps):\n            self.props: CustomLimit.CustomLimitProperties = newProps\n\n        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:\n            # This method contains logic used to generate the spark code from the given inputs.\n            return in0\n'))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},'\npackage prophecyioteam.helloworldscala.gems\n\nimport io.prophecy.gems._\nimport io.prophecy.gems.dataTypes._\nimport io.prophecy.gems.uiSpec._\nimport io.prophecy.gems.diagnostics._\nimport io.prophecy.gems.componentSpec._\nimport org.apache.spark.sql.{DataFrame, SparkSession}\nimport io.prophecy.gems.copilot._\nimport play.api.libs.json.{Format, OFormat, JsResult, JsValue, Json}\n\n\nclass CustomLimit extends ComponentSpec {\n\n  val name: String = "CustomLimit"\n  val category: String = "Transform"\n  type PropertiesType = CustomLimitProperties\n  override def optimizeCode: Boolean = true\n\n  case class CustomLimitProperties(\n    @Property("Property1")\n    property1: String = ""\n  ) extends ComponentProperties\n\n  implicit val CustomLimitPropertiesFormat: Format[CustomLimitProperties] = Json.format\n\n  def dialog: Dialog = Dialog("CustomLimit")\n\n  def validate(component: Component)(implicit context: WorkflowContext): List[Diagnostic] = Nil\n\n  def onChange(oldState: Component, newState: Component)(implicit context: WorkflowContext): Component = newState\n\n  def deserializeProperty(props: String): CustomLimitProperties = Json.parse(props).as[CustomLimitProperties]\n\n  def serializeProperty(props: CustomLimitProperties): String = Json.toJson(props).toString()\n\n  class CustomLimitCode(props: PropertiesType) extends ComponentCode {\n    def apply(spark: SparkSession, in: DataFrame): DataFrame = {\n      val out = in\n      out\n    }\n  }\n}\n')))),(0,o.yg)("p",null,"The template consists of the following components:"),(0,o.yg)("table",null,(0,o.yg)("thead",{parentName:"table"},(0,o.yg)("tr",{parentName:"thead"},(0,o.yg)("th",{parentName:"tr",align:null},"Component"),(0,o.yg)("th",{parentName:"tr",align:null},"Description"))),(0,o.yg)("tbody",{parentName:"table"},(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Parent class"),(0,o.yg)("td",{parentName:"tr",align:null},"Extends a parent class from which it inherits the representation of the overall gem.")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Optimize function"),(0,o.yg)("td",{parentName:"tr",align:null},"Enable or disable ",(0,o.yg)("a",{parentName:"td",href:"/extensibility/gem-builder/optimization-functions"},"code optimization"),".")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Properties class"),(0,o.yg)("td",{parentName:"tr",align:null},"Contains a list of the properties to be made available to the user for this particular gem.")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Dialog function"),(0,o.yg)("td",{parentName:"tr",align:null},"Contains code specific to how the gem UI should look to the user.")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Serialize/deserialize function (",(0,o.yg)("strong",{parentName:"td"},"Scala only"),")"),(0,o.yg)("td",{parentName:"tr",align:null},"Persists objects or exchanges data between different parts of a system")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Validate function"),(0,o.yg)("td",{parentName:"tr",align:null},"Recognizes errors with any inputs provided by the user.")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"State change function"),(0,o.yg)("td",{parentName:"tr",align:null},"Defines UI state transformations.")),(0,o.yg)("tr",{parentName:"tbody"},(0,o.yg)("td",{parentName:"tr",align:null},"Component code class"),(0,o.yg)("td",{parentName:"tr",align:null},"Contains the Spark code that needs to run on your Spark cluster.")))),(0,o.yg)("h2",{id:"tutorial"},"Tutorial"),(0,o.yg)("h3",{id:"create-a-gem"},"Create a gem"),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Create a Spark project in Python. The gem will inherit the project-level language."),(0,o.yg)("li",{parentName:"ol"},"Click on the ",(0,o.yg)("strong",{parentName:"li"},"+")," in the Gems section of the project sidebar. This will appear on hover."),(0,o.yg)("li",{parentName:"ol"},"In the ",(0,o.yg)("strong",{parentName:"li"},"Gem Name")," field, write ",(0,o.yg)("inlineCode",{parentName:"li"},"CustomLimit"),"."),(0,o.yg)("li",{parentName:"ol"},"Choose ",(0,o.yg)("strong",{parentName:"li"},"Transformation Gem")," mode."),(0,o.yg)("li",{parentName:"ol"},"Select the ",(0,o.yg)("strong",{parentName:"li"},"Transform")," category."),(0,o.yg)("li",{parentName:"ol"},"Click ",(0,o.yg)("strong",{parentName:"li"},"Create Gem"),".")),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"Create gem",src:a(5190).A,width:"2620",height:"1508"})),(0,o.yg)("p",null,"Next, we'll add custom code the to code template. The best way to learn how to create new gems is to review the code of existing gems. In this tutorial, we will base our custom gem on the Limit gem. Afterward, you can extend the custom gem logic further."),(0,o.yg)("h3",{id:"update-header"},"Update header"),(0,o.yg)("admonition",{type:"note"},(0,o.yg)("p",{parentName:"admonition"},'For gems written in Scala, be sure to update the package to reflect the project name. For example, if the gem is in a "Framework" project, use the statement ',(0,o.yg)("inlineCode",{parentName:"p"},"package platform.framework.Gems"))),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},"from prophecy.cb.server.base.ComponentBuilderBase import *\nfrom pyspark.sql import *\nfrom pyspark.sql.functions import *\n\nfrom prophecy.cb.server.base.datatypes import SInt\nfrom prophecy.cb.ui.uispec import *\nfrom prophecy.cb.server.base import WorkflowContext\n\n"))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},"\npackage platform.< project name >.Gems\nimport io.prophecy.Gems._\nimport io.prophecy.Gems.componentSpec._\nimport io.prophecy.Gems.dataTypes._\nimport io.prophecy.Gems.diagnostics._\nimport io.prophecy.Gems.uiSpec._\nimport org.apache.spark.sql.{DataFrame, SparkSession}\nimport play.api.libs.json.{Format, Json}\n\n")))),(0,o.yg)("h3",{id:"extend-parent-class"},"Extend parent class"),(0,o.yg)("p",null,"Every Gem class needs to extend a parent class from which it inherits the representation of the overall Gem. This includes the UI and the logic. For transform Gems, you need to extend ComponentSpec ."),(0,o.yg)("p",null,'Next provide the name and category of your Gem, "Limit" and "Transform" in this example.'),(0,o.yg)("p",null,"Another thing to note here is optimizeCode. This flag can be set to True or False value depending on whether we want the Prophecy Optimizer to run on this code to simplify it. In most cases, it's best to leave this value as True."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},'class Limit(ComponentSpec):\n    name: str = "Limit"\n    category: str = "Transform"\n    GemDescription: str = "Limits the number of rows in the output"\n    docUrl: str = "https://docs.prophecy.io/Spark/Gems/transform/limit/"\n\n    def optimizeCode(self) -> bool:\n        return True\n\n    @dataclass(frozen=True)\n\n'))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},'\nclass Limit extends ComponentSpec {\n\n  val name: String = "Limit"\n  val category: String = "Transform"\n  val GemDescription: String = "Limits the number of rows in the input data"\n  val docUrl: String = "https://docs.prophecy.io/Spark/Gems/transform/limit/"\n\n  type PropertiesType = LimitProperties\n  override def optimizeCode: Boolean = true\n  ...\n')))),(0,o.yg)("p",null,"For our CustomLimit gem, we can start with the same code as the Limit gem and change the ",(0,o.yg)("inlineCode",{parentName:"p"},"class")," name and the ",(0,o.yg)("inlineCode",{parentName:"p"},"val")," name."),(0,o.yg)("h3",{id:"populate-properties-class"},"Populate properties class"),(0,o.yg)("p",null,"There is one class (seen here as LimitProperties) that contains a list of the properties to be made available to the user for this particular Gem. Think of these as all the values a user fills out within the interface of this Gem, or any other UI state that you need to maintain (seen here as limit)."),(0,o.yg)("admonition",{type:"caution"},(0,o.yg)("p",{parentName:"admonition"},"The content of these Properties classes is persisted in JSON and stored in Git.")),(0,o.yg)("p",null,"These properties are available in validate, onChange and apply and can be set from dialog, functions."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},'    class LimitProperties(ComponentProperties):\n        limit: SInt = SInt("10")\n\n'))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},'\n  case class LimitProperties(\n    @Property("Limit", "Number of rows to limit the incoming DataFrame to")\n    limit: SInt = SInt("10")\n  ) extends ComponentProperties\n\n')))),(0,o.yg)("p",null,"For our CustomLimit Gem, we can take the same case class as the Limit Gem, maybe changing the default limit value."),(0,o.yg)("p",null,"Now let\u2019s take a look at the methods for the UI Gem component."),(0,o.yg)("h3",{id:"create-ui-components"},"Create UI components"),(0,o.yg)("p",null,"The dialog function contains code specific to how the Gem UI should look to the user."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},' def dialog(self) -> Dialog:\n        return Dialog("Limit").addElement(\n            ColumnsLayout(gap="1rem", height="100%")\n                .addColumn(PortSchemaTabs().importSchema(), "2fr")\n                .addColumn(\n                ExpressionBox("Limit")\n                    .bindPlaceholder("10")\n                    .bindProperty("limit")\n                    .withFrontEndLanguage(),\n                "5fr"\n            )\n        )\n\n\n'))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},' def dialog: Dialog = Dialog("Limit")\n    .addElement(\n      ColumnsLayout(gap = Some("1rem"), height = Some("100%"))\n        .addColumn(PortSchemaTabs().importSchema(), "2fr")\n        .addColumn(\n          ExpressionBox("Limit")\n            .bindProperty("limit")\n            .bindPlaceholder("10")\n            .withFrontEndLanguage,\n          "5fr"\n        )\n    )\n')))),(0,o.yg)("p",null,"The above Dialog function in the limit Gem is rendered on the UI like this:\n",(0,o.yg)("img",{alt:"UI",src:a(19450).A,width:"1838",height:"1060"})),(0,o.yg)("p",null,"There are various UI components that can be defined for custom Gems such as scroll boxes, tabs, buttons, etc."),(0,o.yg)("p",null,"These UI components can be grouped together in various types of panels to create a custom user experience when using the Gem. After the Dialog object is defined, it's serialized as JSON, sent to the UI, and rendered there."),(0,o.yg)("p",null,"Depending on what kind of Gem is being created, either a Dialog or a DatasetDialog needs to be defined. See Transformation vs DatasetFormat Gems for details."),(0,o.yg)("p",null,"Take a look through the Gems inside SparkBasicsScala and SparkBasicsPython Projects to for more example dialog methods."),(0,o.yg)("h3",{id:"validate-user-input"},"Validate user input"),(0,o.yg)("p",null,"The validate method performs validation checks so that in the case where there's any issue with any inputs provided for the user an Error can be displayed. In our example case the Limit condition must be an integer within a defined range. Similarly, you can add any validation on your properties."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},' def validate(self, context: WorkflowContext, component: Component[LimitProperties]) -> List[Diagnostic]:\n        diagnostics = []\n        limitDiagMsg = "Limit has to be an integer between [0, (2**31)-1]"\n        if component.properties.limit.diagnosticMessages is not None and len(component.properties.limit.diagnosticMessages) > 0:\n            for message in component.properties.limit.diagnosticMessages:\n                diagnostics.append(Diagnostic("properties.limit", message, SeverityLevelEnum.Error))\n        else:\n            resolved = component.properties.limit.value\n            if resolved <= 0:\n                diagnostics.append(Diagnostic("properties.limit", limitDiagMsg, SeverityLevelEnum.Error))\n            else:\n                pass\n        return diagnostics\n'))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},' def validate(component: Component)(implicit context: WorkflowContext): List[Diagnostic] = {\n    import Scala.collection.mutable.ListBuffer\n\n    val diagnostics = ListBuffer[Diagnostic]()\n\n    val (diag, limit) = (component.properties.limit.diagnostics, component.properties.limit.value)\n    diagnostics ++= diag\n\n    val limitDiagMsg = "Limit has to be an integer between [0, (2**31)-1]"\n    if (limit.isDefined) {\n      if (limit.get < 0)\n        diagnostics += Diagnostic("properties.limit", limitDiagMsg, SeverityLevel.Error)\n    }\n    diagnostics.toList\n  }\n\n')))),(0,o.yg)("h3",{id:"define-state-changes"},"Define state changes"),(0,o.yg)("p",null,"The onChange method is given for the UI State transformations. You are given both the previous and the new incoming state and can merge or modify the state as needed. The properties of the Gem are also accessible to this function, so functions like selecting columns, etc. are possible to add from here."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},"    def onChange(self, context: WorkflowContext, oldState: Component[LimitProperties], newState: Component[LimitProperties]) -> Component[\n        LimitProperties]:\n        return newState\n"))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},"  def onChange(oldState: Component, newState: Component)(implicit context: WorkflowContext): Component = newState\n")))),(0,o.yg)("h3",{id:"serialize-or-deserialize"},"Serialize or deserialize"),(0,o.yg)("p",null,"Serialize and deserialize methods in Scala are now open source and exposed to the user, so you could extend your own serializer classes if desired, using Play JSON ",(0,o.yg)("a",{parentName:"p",href:"https://www.playframework.com/documentation/2.8.x/ScalaJson"},"library")," or any other format."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},"< not applicable for Python >\n"))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},"\n override def deserializeProperty(props: String): PropertiesType = Json.parse(props).as[PropertiesType]\n\n  override def serializeProperty(props: PropertiesType): String = Json.stringify(Json.toJson(props))\n\n")))),(0,o.yg)("admonition",{type:"note"},(0,o.yg)("p",{parentName:"admonition"},"For Scala, this snippet binds the UI Properties to the case class:"),(0,o.yg)("p",{parentName:"admonition"},(0,o.yg)("inlineCode",{parentName:"p"},"(props: testProperties): String = Json.toJson(props).toString()"))),(0,o.yg)("h3",{id:"define-spark-logic"},"Define Spark logic"),(0,o.yg)("p",null,"The last class used here is LimitCode which is inherited from ComponentCode class. This class contains the actual Spark code that needs to run on your Spark cluster. The Spark code for the Gem logic is defined in the apply function. Input/Output of apply method can only be DataFrame or list of DataFrames or empty. For example, we are calling the .limit() method in this example in the apply function."),(0,o.yg)(r.A,{mdxType:"Tabs"},(0,o.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-py"},"\n    class LimitCode(ComponentCode):\n        def __init__(self, newProps):\n            self.props: Limit.LimitProperties = newProps\n\n        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:\n            return in0.limit(self.props.limit.value)\n\n"))),(0,o.yg)(i.A,{value:"Scala",label:"Scala",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-scala"},"class LimitCode(props: PropertiesType) extends ComponentCode {\n\n    def apply(spark: SparkSession, in: DataFrame): DataFrame = {\n      val out = in.limit(props.limit)\n      out\n    }\n\n  }\n")))),(0,o.yg)("p",null,"You can go ahead and preview the component to see how it looks. Note some Gem examples have functions defined within the apply method."),(0,o.yg)("p",null,"That\u2019s all the code for our example Transformation, the Limit Gem. We walked through the package and import statements, parent class, and properties class. We explored the required methods dialog, validation, onChange, (de)serializeProperty. Finally we saw the Limit Gem\u2019s component code. Now we have a basic understanding of the components needed for any Transformation Gem."),(0,o.yg)("admonition",{type:"info"},(0,o.yg)("p",{parentName:"admonition"},"If you are using an existing Gem as a guide to creating your new Gem, you will need to change the following at a minimum: ComponentSpec, ComponentProperties, and ComponentCode.")),(0,o.yg)("h2",{id:"extend-functionality"},"Extend functionality"),(0,o.yg)("p",null,"Now for the fun part! We understand a Transform example, and now we want to explore extending to our custom Gem needs. There are several ways to extend your custom Gem."),(0,o.yg)("p",null,"Looking to craft or adjust a UI element for your custom Gem? Get inspiration from the existing Gems. Find a Gem that has a UI element you want to use - like ColumnsLayout - and use that Gem\u2019s code."),(0,o.yg)("p",null,"Looking to supply your own function for your custom Gem? Add your function in the ComponentCode\u2019s apply method."),(0,o.yg)("p",null,"Looking to read or write to a data format beyond the (filetypes, warehouses, and catalog) provided out of the box? GemBuilder is not just for Transformations. Design a new DatasetFormat with GemBuilder using some modifications from the Transformation example."),(0,o.yg)("h3",{id:"extend-ui"},"Extend UI"),(0,o.yg)("p",null,"Let\u2019s see how to use the ColumnsLayout UI element in detail:"),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"8",src:a(7125).A,width:"2880",height:"1084"}),"\nOpen the ",(0,o.yg)("strong",{parentName:"p"},"(1) SparkBasics")," package dependency for Python or Scala. Explore and scroll to find a Gem, e.g. ",(0,o.yg)("strong",{parentName:"p"},"(2) OrderBy")," with the desired visual component, in this case ColumnsLayout. Find the ",(0,o.yg)("strong",{parentName:"p"},"(3) relevant code")," for the visual element and click ",(0,o.yg)("strong",{parentName:"p"},"(4) Preview")," to see how this visual element is rendered. Try it out! Click on the ",(0,o.yg)("strong",{parentName:"p"},"(5)customer_id and email")," columns, and note these columns now ",(0,o.yg)("strong",{parentName:"p"},"(6) appear")," in the Order Columns list."),(0,o.yg)("p",null,"If you like the column layout, then add the ColumnsLayout element to your custom Gem. Each time you edit the code, you can click \u201cPreview\u201d to test the change in the UI."),(0,o.yg)("h3",{id:"extend-the-component-code-with-functions"},"Extend the Component Code with functions"),(0,o.yg)("p",null,"The ComponentCode contains the actual Spark code that needs to run on your Spark cluster. Functions are supported inside the apply method; just define and call the function."),(0,o.yg)("p",null,"For example, the existing Filter ComponentCode can be ",(0,o.yg)("strong",{parentName:"p"},"(1) edited")," by adding the withColumn function:\n",(0,o.yg)("img",{alt:"9",src:a(71178).A,width:"2880",height:"1084"}),"\nClicking ",(0,o.yg)("strong",{parentName:"p"},"(2) Preview")," will allow you to view the Gem\u2019s ",(0,o.yg)("strong",{parentName:"p"},"(3) UI"),". Clicking ",(0,o.yg)("strong",{parentName:"p"},"(4) Preview Code")," will allow you to view the Gem\u2019s ",(0,o.yg)("strong",{parentName:"p"},"(5) code")," together with the ",(0,o.yg)("strong",{parentName:"p"},"(3) UI"),", facilitating iteration. See the code samples below in Scala."),(0,o.yg)("p",null,"filter ComponentCode:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},"  class FilterCode(props: PropertiesType)(implicit context: WorkflowContext) extends ComponentCode {\n\n    def apply(spark: SparkSession, in: DataFrame): DataFrame = {\n      val out = in.filter(props.condition.column)\n      out\n    }\n\n  }\n")),(0,o.yg)("p",null,"filter ComponentCode with the added withColumn function:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},'  class FilterCode(props: PropertiesType)(implicit context: WorkflowContext) extends ComponentCode {\n\n    def apply(spark: SparkSession, in: DataFrame): DataFrame = {\n      import org.apache.spark.sql.functions._\n\n      def func(df: DataFrame): DataFrame = {\n        df.withColumn("test_col", lit(123))\n          .where("1 == 1")\n      }\n\n      val out = in.filter(props.condition.column)\n      func(out)\n    }\n\n  }\n')),(0,o.yg)("h3",{id:"extend-the-readwrite-capabilities-with-dataset-format-gems"},"Extend the read/write capabilities with Dataset Format Gems"),(0,o.yg)("p",null,"You may also wish to create a source or target Dataset format beyond the ",(0,o.yg)("a",{parentName:"p",href:"/Spark/gems/source-target/"},"provided formats"),". With GemBuilder, it\u2019s possible to create custom Dataset formats! You\u2019ll need to know how the source Gems differ from transformation Gems."),(0,o.yg)("p",null,"The DatasetFormat Gem:"),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"class extends DatasetSpec"),(0,o.yg)("li",{parentName:"ol"},"has two Dialog functions: sourceDialog and targetDialog . They both return a DatasetDialog object, whereas for any Transform Gem, the dialog function returns a Dialog object."),(0,o.yg)("li",{parentName:"ol"},"The ComponentCode class has two apply functions: sourceApply and targetApply for Source and Target modes respectively.")),(0,o.yg)("p",null,"There is no distinction between Transformation and DatasetFormat Gem onChange and validate functions."),(0,o.yg)("h2",{id:"troubleshoot-errors"},"Troubleshoot errors"),(0,o.yg)("p",null,"If there is an error in your code, your gem preview might not render correctly."),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"5",src:a(83070).A,width:"2880",height:"1084"}),"\nIf there is a ",(0,o.yg)("strong",{parentName:"p"},"(1) typo / error")," in a required method (e.g. dialog1 instead of dialog), Prophecy will direct your attention to a particular line of code."),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"Click the ",(0,o.yg)("strong",{parentName:"li"},"(2) underlined code"),"."),(0,o.yg)("li",{parentName:"ul"},"Notice a ",(0,o.yg)("strong",{parentName:"li"},"(3) detailed error message"),"."),(0,o.yg)("li",{parentName:"ul"},"Click ",(0,o.yg)("strong",{parentName:"li"},"(4) Preview")," to see how the Gem will look as rendered in the UI."),(0,o.yg)("li",{parentName:"ul"},"If a value is incorrect, the Gem will not be able to be parsed, and a very clear error will appear ",(0,o.yg)("strong",{parentName:"li"},"(5) here")," as well."),(0,o.yg)("li",{parentName:"ul"},"Click the ",(0,o.yg)("strong",{parentName:"li"},"(6) Errors")," button to see the ",(0,o.yg)("strong",{parentName:"li"},"(7) full error message"),".")),(0,o.yg)("admonition",{type:"caution"},(0,o.yg)("p",{parentName:"admonition"},"\u201cThe gem specification could not be parsed\u201d means that there\u2019s an error in one or more required methods, classes, or properties. These components could not be analyzed and/or converted into the gem UI.")),(0,o.yg)("h2",{id:"whats-next"},"What's next?"),(0,o.yg)("p",null,"Now that you know how to create Spark gems, have a look at how to ",(0,o.yg)("a",{parentName:"p",href:"/extensibility/gem-builder/sql-gem-builder"},"create custom SQL gems"),"."))}g.isMDXComponent=!0},83070:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/5-gm-eda8b6494a1b11b6abe7d1ae82b1b492.png"},7125:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/8-gm-da282223983543be9e4f5e20c00d32a9.png"},71178:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/9-gm-8f4862231b0b1999e29c84f0471a6b8e.png"},19450:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/UI-c82484a974682d29d35b5e3abd975cf5.png"},5190:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/create-gem-d0107e5e93d144bf8d774f79fe12d3d2.png"}}]);