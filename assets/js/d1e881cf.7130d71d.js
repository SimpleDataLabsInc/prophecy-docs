"use strict";(self.webpackChunkdocs_4=self.webpackChunkdocs_4||[]).push([[59143],{15680:(e,t,n)=>{n.d(t,{xA:()=>u,yg:()=>g});var a=n(96540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),d=r,g=c["".concat(s,".").concat(d)]||c[d]||m[d]||o;return n?a.createElement(g,i(i({ref:t},u),{},{components:n})):a.createElement(g,i({ref:t},u))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},19365:(e,t,n)=>{n.d(t,{A:()=>i});var a=n(96540),r=n(20053);const o={tabItem:"tabItem_Ymn6"};function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.A)(o.tabItem,i),hidden:n},t)}},11470:(e,t,n)=>{n.d(t,{A:()=>w});var a=n(58168),r=n(96540),o=n(20053),i=n(23104),l=n(56347),s=n(57485),p=n(31682),u=n(89466);function c(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}function m(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??c(n);return function(e){const t=(0,p.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:n}=e;const a=(0,l.W6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s.aZ)(o),(0,r.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(a.location.search);t.set(o,e),a.replace({...a.location,search:t.toString()})}),[o,a])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,o=m(e),[i,l]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[s,p]=g({queryString:n,groupId:a}),[c,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,o]=(0,u.Dv)(n);return[a,(0,r.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:a}),y=(()=>{const e=s??c;return d({value:e,tabValues:o})?e:null})();(0,r.useLayoutEffect)((()=>{y&&l(y)}),[y]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!d({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),p(e),h(e)}),[p,h,o]),tabValues:o}}var y=n(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function f(e){let{className:t,block:n,selectedValue:l,selectValue:s,tabValues:p}=e;const u=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.a_)(),m=e=>{const t=e.currentTarget,n=u.indexOf(t),a=p[n].value;a!==l&&(c(t),s(a))},d=e=>{let t=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const n=u.indexOf(e.currentTarget)+1;t=u[n]??u[0];break}case"ArrowLeft":{const n=u.indexOf(e.currentTarget)-1;t=u[n]??u[u.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":n},t)},p.map((e=>{let{value:t,label:n,attributes:i}=e;return r.createElement("li",(0,a.A)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>u.push(e),onKeyDown:d,onClick:m},i,{className:(0,o.A)("tabs__item",b.tabItem,i?.className,{"tabs__item--active":l===t})}),n??t)})))}function v(e){let{lazy:t,children:n,selectedValue:a}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function k(e){const t=h(e);return r.createElement("div",{className:(0,o.A)("tabs-container",b.tabList)},r.createElement(f,(0,a.A)({},e,t)),r.createElement(v,(0,a.A)({},e,t)))}function w(e){const t=(0,y.A)();return r.createElement(k,(0,a.A)({key:String(t)},e))}},76140:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>g,frontMatter:()=>l,metadata:()=>p,toc:()=>c});var a=n(58168),r=(n(96540),n(15680)),o=n(11470),i=n(19365);const l={sidebar_position:3,title:"PineconeLookup",id:"ml-pinecone-lookup",description:"Lookup a vector embedding from a Pinecone Database",tags:["generative-ai","machine-learning","llm","pinecone","openai"]},s=void 0,p={unversionedId:"Spark/gems/machine-learning/ml-pinecone-lookup",id:"Spark/gems/machine-learning/ml-pinecone-lookup",title:"PineconeLookup",description:"Lookup a vector embedding from a Pinecone Database",source:"@site/docs/Spark/gems/machine-learning/ml-pinecone-lookup.md",sourceDirName:"Spark/gems/machine-learning",slug:"/Spark/gems/machine-learning/ml-pinecone-lookup",permalink:"/Spark/gems/machine-learning/ml-pinecone-lookup",draft:!1,tags:[{label:"generative-ai",permalink:"/tags/generative-ai"},{label:"machine-learning",permalink:"/tags/machine-learning"},{label:"llm",permalink:"/tags/llm"},{label:"pinecone",permalink:"/tags/pinecone"},{label:"openai",permalink:"/tags/openai"}],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"PineconeLookup",id:"ml-pinecone-lookup",description:"Lookup a vector embedding from a Pinecone Database",tags:["generative-ai","machine-learning","llm","pinecone","openai"]},sidebar:"defaultSidebar",previous:{title:"OpenAI",permalink:"/Spark/gems/machine-learning/ml-openai"},next:{title:"Subgraph",permalink:"/Spark/gems/subgraph/"}},u={},c=[{value:"Gem Parameters",id:"gem-parameters",level:3},{value:"Credentials",id:"credentials",level:4},{value:"Properties",id:"properties",level:4},{value:"Input",id:"input",level:3},{value:"Output",id:"output",level:3},{value:"FAQ",id:"faq",level:3},{value:"Troubleshooting",id:"troubleshooting",level:4},{value:"Creating a Pinecone Index",id:"creating-a-pinecone-index",level:4}],m={toc:c},d="wrapper";function g(e){let{components:t,...l}=e;return(0,r.yg)(d,(0,a.A)({},m,l,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h3",null,(0,r.yg)("span",{class:"badge rounded-pill text-bg-light"},"Spark Gem")),(0,r.yg)("p",null,"The PineconeLookup Gem identifies content that is similar to a provided vector embedding. The Gem calls the Pinecone API and returns a set of IDs with highest similarity to the provided embedding."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#gem-parameters"},(0,r.yg)("strong",{parentName:"a"},"Parameters:"))," Configure the parameters needed to call the Pinecone API.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#input"},(0,r.yg)("strong",{parentName:"a"},"Input:"))," This Gem requires an embedding as input. The embedding is provided by a foundational model like ",(0,r.yg)("a",{parentName:"p",href:"https://platform.openai.com/docs/introduction"},"OpenAI"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#output"},(0,r.yg)("strong",{parentName:"a"},"Output:"))," This Gem outputs an array of IDs with corresponding similarity scores."))),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Input and Output",src:n(17921).A,width:"2376",height:"814"})),(0,r.yg)("p",null,"Now let\u2019s understand the Gem Parameters, Input, and Output in detail."),(0,r.yg)("div",{class:"wistia_responsive_padding",style:{padding:"56.25% 0 0 0",position:"relative"}},(0,r.yg)("div",{class:"wistia_responsive_wrapper",style:{height:"100%",left:0,position:"absolute",top:0,width:"100%"}},(0,r.yg)("iframe",{src:"https://fast.wistia.net/embed/iframe/nupkza0ir6?seo=false?videoFoam=true",title:"Getting Started With SQL Video",allow:"autoplay; fullscreen",allowtransparency:"true",frameborder:"0",scrolling:"no",class:"wistia_embed",name:"wistia_embed",msallowfullscreen:!0,width:"100%",height:"100%"}))),(0,r.yg)("script",{src:"https://fast.wistia.net/assets/external/E-v1.js",async:!0}),(0,r.yg)("br",null),(0,r.yg)("h3",{id:"gem-parameters"},"Gem Parameters"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Parameters",src:n(16869).A,width:"2880",height:"1726"})),(0,r.yg)("p",null,"Verify the ",(0,r.yg)("strong",{parentName:"p"},"(1) input columns")," contain a column with the embeddings. The structure of this column's entries must be compatible with the structure of the Pinecone index."),(0,r.yg)("h4",{id:"credentials"},"Credentials"),(0,r.yg)("p",null,"Configure the Pinecone API credentials here. Storing the Pinecone API token as a ",(0,r.yg)("strong",{parentName:"p"},"(2) Databricks Secret")," is highly recommended. For instructions click ",(0,r.yg)("a",{parentName:"p",href:"https://docs.databricks.com/en/security/secrets/index.html"},"here.")," Be sure to use the ",(0,r.yg)("strong",{parentName:"p"},"(3) Fabric connection")," to the Databricks workspace which contains the Databricks scope and secrets configured in this Gem."),(0,r.yg)("p",null,"Hardcoding the Pinecone credential is not recommended. Selecting this option could send credentials to be stored hardcoded in Git; ",(0,r.yg)("a",{parentName:"p",href:"https://www.prophecy.io/request-a-demo"},"reach out")," to understand the integrations with other secret managers."),(0,r.yg)("h4",{id:"properties"},"Properties"),(0,r.yg)("p",null,"Pinecone DB uses indexing to map the vectors to a data structure that will enable faster searching. The PineconeLookup Gem searches through a Pinecone index to identify embeddings with similarity to the input embedding. Enter the Pinecone ",(0,r.yg)("strong",{parentName:"p"},(0,r.yg)("a",{parentName:"strong",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#faq"},"(4) Index name"))," which you\u2019d like to use for looking up embeddings."),(0,r.yg)("p",null,"Select one of the Gem\u2019s input columns with vector embeddings as the ",(0,r.yg)("strong",{parentName:"p"},"(5) Vector column")," to send to Pinecone\u2019s API. The column ",(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#input"},"must")," be compatible with the Pinecone Index. To change the column\u2019s datatype and properties, ",(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#faq"},"configure")," the Gem(s) preceding the PineconeLookup Gem."),(0,r.yg)("p",null,"Pinecone\u2019s API can return multiple results. Depending on the use case, select the desired ",(0,r.yg)("strong",{parentName:"p"},"(6) Number of results")," sorted by similarity score. The result with highest similarity to the user\u2019s text question will be listed first."),(0,r.yg)("h3",{id:"input"},"Input"),(0,r.yg)("p",null,"PineconeLookup requires a model_embedding column as input. Use one of Prophecy's Machine Learning Gems to provide the model_embedding. For example, the OpenAI Gem can precede the PineconeLookup Gem in the Pipeline. The OpenAI Gem, configured to ",(0,r.yg)("inlineCode",{parentName:"p"},"Compute a text embedding"),", will output an openai_embedding column. This is a suitable input for the PineconeLookup Gem."),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Column"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"),(0,r.yg)("th",{parentName:"tr",align:null},"Required"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"model_embedding"),(0,r.yg)("td",{parentName:"tr",align:null},"array(float) - The format of this embedding is important. It must be an array of floating point numbers that matches the requirements of the Pinecone index. For example, we used a Pinecone index with ",(0,r.yg)("inlineCode",{parentName:"td"},"1536")," dimensions, ",(0,r.yg)("inlineCode",{parentName:"td"},"Cosine")," metric, and an ",(0,r.yg)("inlineCode",{parentName:"td"},"s1")," pod type. So each record in the model_embedding column must be an array of ",(0,r.yg)("inlineCode",{parentName:"td"},"1536")," floating point numbers, such as ",(0,r.yg)("inlineCode",{parentName:"td"},"[-0.0018493991, -0.0059955865, ... -0.02498541]"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"True")))),(0,r.yg)("h3",{id:"output"},"Output"),(0,r.yg)("p",null,"The output Dataset contains the pinecone_matches and pinecone_error columns. For each input content entry, this Gem adds an array to the pinecone_matches column. The output array will have ",(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/Spark/gems/machine-learning/ml-pinecone-lookup#properties"},"Number of Results")," entries."),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Column"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"pinecone_matches"),(0,r.yg)("td",{parentName:"tr",align:null},"array - an array of several content IDs and their scores. Example: ",(0,r.yg)("inlineCode",{parentName:"td"},'[{"id":"web-223","score":0.8437653},{"id":"web-224","score":0.8403446}, ...{"id":"web-237","score":0.82916564}]'))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"pinecone_error"),(0,r.yg)("td",{parentName:"tr",align:null},"string - this column is provided to show any error message returned from Pinecone\u2019s API; helpful for troubleshooting errors related to the PineconeLookup Gem.")))),(0,r.yg)("p",null,"Prophecy converts the visual design into Spark code available on the Prophecy user's Git repository. Find the Spark code for the PineconeLookup Gem below."),(0,r.yg)(o.A,{mdxType:"Tabs"},(0,r.yg)(i.A,{value:"py",label:"Python",mdxType:"TabItem"},(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-py"},'def vector_lookup(Spark: SparkSession, in0: DataFrame) -> DataFrame:\n    from pySpark.sql.functions import expr, array, struct\n    from Spark_ai.dbs.pinecone import PineconeDB, IdVector\n    from pySpark.dbutils import DBUtils\n    PineconeDB(DBUtils(Spark).secrets.get(scope = "< my_scope >", key = "< my_key >"), "us-east-1-aws")\\\n        .register_udfs(Spark)\n\n    return in0\\\n        .withColumn("_vector", col("<model>_embedding"))\\\n        .withColumn("_response", expr(f"pinecone_query(\\<index name>\\", _vector, {3})"))\\\n        .withColumn("pinecone_matches", col("_response.matches"))\\\n        .withColumn("pinecone_error", col("_response.error"))\\\n        .drop("_vector", "_response")\n'))),(0,r.yg)(i.A,{value:"scala",label:"Scala",mdxType:"TabItem"},(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"  [Not yet supported]\n")))),(0,r.yg)("h3",{id:"faq"},"FAQ"),(0,r.yg)("h4",{id:"troubleshooting"},"Troubleshooting"),(0,r.yg)("p",null,"To troubleshoot the Gem preceding PineconeLookup, open the data preview output from the previous Gem. For example if the embedding structure is incorrect then try adjusting the previous Gem, run, and view that Gem\u2019s output data preview."),(0,r.yg)("h4",{id:"creating-a-pinecone-index"},"Creating a Pinecone Index"),(0,r.yg)("p",null,"If you don\u2019t have one yet, ",(0,r.yg)("a",{parentName:"p",href:"https://docs.pinecone.io/docs/quickstart"},"create a Pinecone index"),". Click ",(0,r.yg)("a",{parentName:"p",href:"https://docs.pinecone.io/docs/choosing-index-type-and-size"},"here")," for pointers on choosing an index type and size. How to populate the index? For example, ",(0,r.yg)("a",{parentName:"p",href:"https://docs.prophecy.io/getting-started/gen-ai-chatbot#step-2-build-a-knowledge-warehouse"},"this guide")," shows how to ingest and vectorize web content data to store in a Pinecone Database index."))}g.isMDXComponent=!0},16869:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/pinecone_lookup_configure-c0222e658f0a0e83456793ea8e3bffd0.png"},17921:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/pinecone_lookup_input_output-268c3aecc7c4cb663c302cdd2682e30f.png"}}]);